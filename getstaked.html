<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staking and Rewards overview</title>
    <link rel="apple-touch-icon" sizes="180x180" href="../favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../favicon/favicon-16x16.png">
    <link rel="manifest" href="../favicon/site.webmanifest">
    <script src="ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
    </style>
</head>
<body>
<div>
    <p><b>How to use?</b> Input any address and click the button</p>
  <label for="addressInput">Enter Address:</label>
  <input type="text" style="width:600px;" id="addressInput" placeholder="0x1234..." value="<?= (isset($_GET["address"])?$_GET["address"]:"") ?>" autofocus>
  <button id="checkBalanceButton">Check Balances & Earned Tokens</button>
</div>

<div id="stakeInfo">
    <h2>RST Invitational</h2>
  <p>Currently Staked RST: <span id="currentStakeAmount">0</span></p>
  <p>Multiplier: <span id="multiplier">x0</span></p>
</div>

<div id="xPhotonInfo">
    <h2>xPhoton</h2>
  <p>Staked xPhoton: <span id="stakedXPhoton">0</span></p>
</div>
<div id="earnedInfo">
  <p>Earned RST from xPhoton staking that's available to withdraw: <span id="earnedTokens">0</span> RST</p>
</div>

<div id="oldStakingPoolInfo">
    <h2>Old staking pool (no more rewards!)</h2>
    <p>Staked RST: <span id="oldStakedRST">0</span></p>
</div>

<script>
  const addressInput = document.getElementById("addressInput");
  const checkBalanceButton = document.getElementById("checkBalanceButton");
  const currentStakeAmountDisplay = document.getElementById("currentStakeAmount");
  const multiplierDisplay = document.getElementById("multiplier");
  const earnedTokensDisplay = document.getElementById("earnedTokens");
  const stakedXPhotonDisplay = document.getElementById("stakedXPhoton");
  const oldStakedRSTDisplay = document.getElementById("oldStakedRST");

  const RST_INVITATIONAL_STAKING_CONTRACT_ADDRESS = "0x1F8b0B05e9b7fC8c9b71FbE79c1270fAa4fb6229";
  const XPHOTON_POOL_ADDRESS = "0x71F0EcbF37EdBbc5A3d7daA968Dc1b8AcbAF2662"; 
  const OLD_STAKING_POOL = "0x88429A9834081ab4042Bae6e520dDa6112798ccF";

  const ERC20_ABI = [
    {
      constant: true,
      inputs: [{ name: "_owner", type: "address" }],
      name: "balanceOf",
      outputs: [{ name: "balance", type: "uint256" }],
      type: "function",
    },
  ];

  const STAKING_ABI = [
    {
      inputs: [{ internalType: "address", name: "_user", type: "address" }],
      name: "getStakeInfo",
      outputs: [{ internalType: "uint256", name: "amount", type: "uint256" }],
      stateMutability: "view",
      type: "function",
    },
  ];

  const REWARDS_ABI = [
    {
      inputs: [{ internalType: "address", name: "account", type: "address" }],
      name: "rstEarned",
      outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
      stateMutability: "view",
      type: "function",
    },
    {
      inputs: [{ internalType: "address", name: "_owner", type: "address" }],
      name: "getStaked",
      outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
      stateMutability: "view",
      type: "function",
    },
  ];

  const OLD_STAKING_ABI = [
    {
      inputs: [{ internalType: "address", name: "", type: "address" }],
      name: "staked",
      outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
      stateMutability: "view",
      type: "function",
    },
  ];

  function calculateMultiplier(amount) {
    const amountInRST = parseFloat(amount) || 0;
    if (amountInRST < 1) {
      return 0;
    }
    if (amountInRST <= 100000) {
      return 1;
    }
    return Math.floor((amountInRST - 1) / 100000) + 1;
  }

  function updateStakeInfo(stakedAmount) {
    const parsedStakedAmount = parseFloat(stakedAmount) || 0;
    currentStakeAmountDisplay.textContent = parsedStakedAmount.toLocaleString(undefined, { maximumFractionDigits: 2 });

    const currentMultiplier = calculateMultiplier(parsedStakedAmount);
    multiplierDisplay.textContent = "x" + currentMultiplier;

    document.getElementById("stakeInfo").style.display = "block";
  }

  async function fetchStakedBalance(address) {
    try {
      const provider = new ethers.JsonRpcProvider("https://build.onbeam.com/rpc");
      const stakingContract = new ethers.Contract(RST_INVITATIONAL_STAKING_CONTRACT_ADDRESS, STAKING_ABI, provider);

      const stakeInfo = await stakingContract.getStakeInfo(address);
      const stakedAmount = ethers.formatUnits(stakeInfo, 18);
      updateStakeInfo(stakedAmount);
    } catch (error) {
      console.error("Error fetching staked balance:", error);
      alert("There was an error fetching the staked balance. Please check the console for details.");
    }
  }

  async function fetchEarnedTokens(address) {
    try {
      const provider = new ethers.JsonRpcProvider("https://build.onbeam.com/rpc");
      const rewardsContract = new ethers.Contract(XPHOTON_POOL_ADDRESS, REWARDS_ABI, provider);

      const earnedTokens = await rewardsContract.rstEarned(address);
      const formattedEarnedTokens = ethers.formatUnits(earnedTokens, 18);
      earnedTokensDisplay.textContent = formattedEarnedTokens.toLocaleString(undefined, { maximumFractionDigits: 2 });
      document.getElementById("earnedInfo").style.display = "block";
    } catch (error) {
      console.error("Error fetching earned tokens:", error);
      alert("There was an error fetching the earned tokens. Please check the console for details.");
    }
  }

  async function fetchStakedXPhoton(address) {
    try {
      const provider = new ethers.JsonRpcProvider("https://build.onbeam.com/rpc");
      const rewardsContract = new ethers.Contract(XPHOTON_POOL_ADDRESS, REWARDS_ABI, provider);

      const stakedXPhoton = await rewardsContract.getStaked(address);
      const formattedStakedXPhoton = ethers.formatUnits(stakedXPhoton, 18);
      stakedXPhotonDisplay.textContent = formattedStakedXPhoton.toLocaleString(undefined, { maximumFractionDigits: 2 });
      document.getElementById("xPhotonInfo").style.display = "block";
    } catch (error) {
      console.error("Error fetching staked xPhoton:", error);
      alert("There was an error fetching the staked xPhoton. Please check the console for details.");
    }
  }

  async function fetchOldStakedRST(address) {
    try {
      const provider = new ethers.JsonRpcProvider("https://build.onbeam.com/rpc");
      const oldStakingContract = new ethers.Contract(OLD_STAKING_POOL, OLD_STAKING_ABI, provider);

      const oldStakedRST = await oldStakingContract.staked(address);
      const formattedOldStakedRST = ethers.formatUnits(oldStakedRST, 18);
      oldStakedRSTDisplay.textContent = formattedOldStakedRST.toLocaleString(undefined, { maximumFractionDigits: 2 });
      document.getElementById("oldStakingPoolInfo").style.display = "block";
    } catch (error) {
      console.error("Error fetching staked RST in old pool:", error);
      alert("There was an error fetching the staked RST in the old pool. Please check the console for details.");
    }
  }

  checkBalanceButton.onclick = function () {
    const address = addressInput.value.trim();
    if (ethers.isAddress(address)) {
      fetchStakedBalance(address);
      fetchEarnedTokens(address);
      fetchStakedXPhoton(address);
      fetchOldStakedRST(address);
    } else {
      alert("Please enter a valid address.");
    }
  };

  window.onload = function () {
    document.getElementById("stakeInfo").style.display = "none";
    document.getElementById("earnedInfo").style.display = "none";
    document.getElementById("xPhotonInfo").style.display = "none";
    document.getElementById("oldStakingPoolInfo").style.display = "none";

      // PHP passing address to JavaScript
      const userAddress = "<?php echo ( isset($_GET["address"]) && preg_match('/^0x[a-fA-F0-9]{40}$/', $_GET["address"]) ) ? $_GET['address'] : ''; ?>";
    
    if (userAddress) {
      addressInput.value = userAddress;
      checkBalanceButton.click(); // Trigger button click if address is present
    }
  };
</script>
</body>
</html>